name: Update MLB Strikeout Props Feed

on:
  schedule:
    # Run every 2 hours from 10 AM to 10 PM ET (during baseball season)
    - cron: '0 14,16,18,20,22,0,2 * * *'  # UTC times
  workflow_dispatch:  # Allow manual triggers
  push:
    paths:
      - 'export_json_feed.py'
      - 'update_public_feed.py'
      - '.github/workflows/update-feed.yml'

jobs:
  update-feed:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Update public feed
      run: |
        python update_public_feed.py
    
    - name: Check for changes
      id: git-check
      run: |
        git diff --exit-code public/ || echo "changes=true" >> $GITHUB_OUTPUT
    
    - name: Commit and push changes
      if: steps.git-check.outputs.changes == 'true'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add public/
        git commit -m "Update MLB strikeout props feed - $(date -u '+%Y-%m-%d %H:%M UTC')"
        git push
    
    - name: Create deployment summary
      if: always()
      run: |
        echo "## ðŸŽ¯ MLB Strikeout Props Feed Update" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        if [ -f "public/api/v1/summary.json" ]; then
          TOTAL_GAMES=$(python -c "import json; data=json.load(open('public/api/v1/summary.json')); print(data['summary']['total_games'])")
          TOTAL_PITCHERS=$(python -c "import json; data=json.load(open('public/api/v1/summary.json')); print(data['summary']['total_pitchers'])")
          LAST_UPDATED=$(python -c "import json; data=json.load(open('public/api/v1/summary.json')); print(data['metadata']['generated_at_formatted'])")
          
          echo "âœ… **Feed updated successfully!**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Total Games:** $TOTAL_GAMES" >> $GITHUB_STEP_SUMMARY
          echo "- **Total Pitchers:** $TOTAL_PITCHERS" >> $GITHUB_STEP_SUMMARY
          echo "- **Last Updated:** $LAST_UPDATED" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ”— **API Endpoints:**" >> $GITHUB_STEP_SUMMARY
          echo "- [Full Data](https://$(echo ${{ github.repository_owner }}).github.io/$(echo ${{ github.event.repository.name }})/api/v1/strikeout-props.json)" >> $GITHUB_STEP_SUMMARY
          echo "- [Summary](https://$(echo ${{ github.repository_owner }}).github.io/$(echo ${{ github.event.repository.name }})/api/v1/summary.json)" >> $GITHUB_STEP_SUMMARY
          echo "- [Best Odds](https://$(echo ${{ github.repository_owner }}).github.io/$(echo ${{ github.event.repository.name }})/api/v1/best-odds.json)" >> $GITHUB_STEP_SUMMARY
          echo "- [Documentation](https://$(echo ${{ github.repository_owner }}).github.io/$(echo ${{ github.event.repository.name }})/)" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ **Feed update failed**" >> $GITHUB_STEP_SUMMARY 